name: OCR Scanner - COMPLETE SOLUTION

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ CREATE ALL FILES
      run: |
        echo "ğŸ”§ CrÃ©ation de TOUS les fichiers nÃ©cessaires..."
        
        # 1. settings.gradle (dÃ©jÃ  bon, mais on s'assure)
        echo 'pluginManagement {' > settings.gradle
        echo '    repositories {' >> settings.gradle
        echo '        google()' >> settings.gradle
        echo '        mavenCentral()' >> settings.gradle
        echo '        gradlePluginPortal()' >> settings.gradle
        echo '    }' >> settings.gradle
        echo '}' >> settings.gradle
        echo '' >> settings.gradle
        echo 'dependencyResolutionManagement {' >> settings.gradle
        echo '    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)' >> settings.gradle
        echo '    repositories {' >> settings.gradle
        echo '        google()' >> settings.gradle
        echo '        mavenCentral()' >> settings.gradle
        echo '    }' >> settings.gradle
        echo '}' >> settings.gradle
        echo '' >> settings.gradle
        echo "rootProject.name = 'OCRScanner'" >> settings.gradle
        echo "include ':app'" >> settings.gradle
        
        # 2. build.gradle (CRITIQUE !)
        echo 'buildscript {' > build.gradle
        echo '    repositories {' >> build.gradle
        echo '        google()' >> build.gradle
        echo '        mavenCentral()' >> build.gradle
        echo '    }' >> build.gradle
        echo '    dependencies {' >> build.gradle
        echo '        classpath "com.android.tools.build:gradle:8.1.0"' >> build.gradle
        echo '        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0"' >> build.gradle
        echo '    }' >> build.gradle
        echo '}' >> build.gradle
        echo '' >> build.gradle
        echo 'allprojects {' >> build.gradle
        echo '    repositories {' >> build.gradle
        echo '        google()' >> build.gradle
        echo '        mavenCentral()' >> build.gradle
        echo '    }' >> build.gradle
        echo '}' >> build.gradle
        echo '' >> build.gradle
        echo 'task clean(type: Delete) {' >> build.gradle
        echo '    delete rootProject.buildDir' >> build.gradle
        echo '}' >> build.gradle
        
        # 3. app/build.gradle minimal
        if [ ! -f "app/build.gradle" ]; then
          mkdir -p app
          echo 'plugins { id "com.android.application"; id "org.jetbrains.kotlin.android" }' > app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.yourapp.ocrscanner"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.yourapp.ocrscanner"' >> app/build.gradle
          echo '        minSdk 24' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    buildTypes { release { minifyEnabled false } }' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.core:core-ktx:1.12.0"' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '}' >> app/build.gradle
        fi
        
        echo "âœ… Tous les fichiers crÃ©Ã©s"
        echo "ğŸ“ Structure :"
        ls -la *.gradle
        ls -la app/*.gradle
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ğŸ—ï¸ Build
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug
        
    - name: ğŸ“¦ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ocr-scanner
        path: app/build/outputs/apk/debug/*.apk
