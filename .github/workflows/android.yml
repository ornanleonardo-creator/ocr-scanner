name: Build OCR Scanner - FINAL FIX

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—‘ï¸ Clean problematic files
      run: |
        echo "ğŸ§¹ Nettoyage des fichiers problÃ©matiques..."
        # Supprimer build.gradle s'il existe
        rm -f build.gradle
        echo "âœ… Fichiers nettoyÃ©s"
        
    - name: ğŸ†• Create clean build.gradle
      run: |
        echo "ğŸ“ CrÃ©ation de build.gradle..."
        # Ã‰crire le fichier ligne par ligne (pas de here-doc)
        echo 'buildscript {' > build.gradle
        echo '    repositories {' >> build.gradle
        echo '        google()' >> build.gradle
        echo '        mavenCentral()' >> build.gradle
        echo '    }' >> build.gradle
        echo '    dependencies {' >> build.gradle
        echo '        classpath "com.android.tools.build:gradle:8.1.0"' >> build.gradle
        echo '        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0"' >> build.gradle
        echo '    }' >> build.gradle
        echo '}' >> build.gradle
        echo '' >> build.gradle
        echo 'allprojects {' >> build.gradle
        echo '    repositories {' >> build.gradle
        echo '        google()' >> build.gradle
        echo '        mavenCentral()' >> build.gradle
        echo '    }' >> build.gradle
        echo '}' >> build.gradle
        echo '' >> build.gradle
        echo 'task clean(type: Delete) {' >> build.gradle
        echo '    delete rootProject.buildDir' >> build.gradle
        echo '}' >> build.gradle
        
        echo "âœ… build.gradle crÃ©Ã©"
        cat build.gradle
        
    - name: ğŸ“± Create app/build.gradle
      run: |
        echo "ğŸ“± CrÃ©ation de app/build.gradle..."
        mkdir -p app
        
        # CrÃ©er le fichier ligne par ligne
        echo 'plugins {' > app/build.gradle
        echo '    id "com.android.application"' >> app/build.gradle
        echo '    id "org.jetbrains.kotlin.android"' >> app/build.gradle
        echo '}' >> app/build.gradle
        echo '' >> app/build.gradle
        echo 'android {' >> app/build.gradle
        echo '    namespace "com.yourapp.ocrscanner"' >> app/build.gradle
        echo '    compileSdk 34' >> app/build.gradle
        echo '' >> app/build.gradle
        echo '    defaultConfig {' >> app/build.gradle
        echo '        applicationId "com.yourapp.ocrscanner"' >> app/build.gradle
        echo '        minSdk 24' >> app/build.gradle
        echo '        targetSdk 34' >> app/build.gradle
        echo '        versionCode 1' >> app/build.gradle
        echo '        versionName "1.0"' >> app/build.gradle
        echo '    }' >> app/build.gradle
        echo '' >> app/build.gradle
        echo '    buildTypes {' >> app/build.gradle
        echo '        release {' >> app/build.gradle
        echo '            minifyEnabled false' >> app/build.gradle
        echo '            proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"' >> app/build.gradle
        echo '        }' >> app/build.gradle
        echo '    }' >> app/build.gradle
        echo '' >> app/build.gradle
        echo '    compileOptions {' >> app/build.gradle
        echo '        sourceCompatibility JavaVersion.VERSION_17' >> app/build.gradle
        echo '        targetCompatibility JavaVersion.VERSION_17' >> app/build.gradle
        echo '    }' >> app/build.gradle
        echo '' >> app/build.gradle
        echo '    kotlinOptions {' >> app/build.gradle
        echo '        jvmTarget = "17"' >> app/build.gradle
        echo '    }' >> app/build.gradle
        echo '}' >> app/build.gradle
        echo '' >> app/build.gradle
        echo 'dependencies {' >> app/build.gradle
        echo '    implementation "androidx.core:core-ktx:1.12.0"' >> app/build.gradle
        echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
        echo '    implementation "com.google.android.material:material:1.10.0"' >> app/build.gradle
        echo '}' >> app/build.gradle
        
        echo "âœ… app/build.gradle crÃ©Ã©"
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ğŸ› ï¸ Make gradlew executable
      run: |
        chmod +x gradlew
        echo "âœ… gradlew rendu exÃ©cutable"
        
    - name: ğŸ—ï¸ Build APK
      run: |
        echo "ğŸš€ DÃ©marrage du build..."
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ğŸ“¦ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ocr-scanner-app
        path: app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
