name: OCR Scanner - Fresh Gradlew

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—‘ï¸ REMOVE corrupted gradlew
      run: |
        echo "ğŸ—‘ï¸ Suppression du fichier gradlew corrompu..."
        rm -f gradlew
        echo "âœ… gradlew supprimÃ©"
        
    - name: ğŸ“¥ DOWNLOAD fresh gradlew
      run: |
        echo "ğŸ“¥ TÃ©lÃ©chargement d'un nouveau gradlew..."
        # TÃ©lÃ©charger depuis la source officielle
        curl -L -o gradlew https://raw.githubusercontent.com/gradle/gradle/master/gradlew
        
        # VÃ©rifier le tÃ©lÃ©chargement
        echo "âœ… TÃ©lÃ©chargement terminÃ©"
        echo "ğŸ“ Taille du fichier : $(wc -l < gradlew) lignes"
        echo "ğŸ“„ PremiÃ¨res lignes :"
        head -5 gradlew
        
    - name: ğŸ”§ SET executable permissions
      run: |
        echo "ğŸ”§ Configuration des permissions..."
        # Donner toutes les permissions
        chmod 755 gradlew
        
        # VÃ©rifier
        echo "âœ… Permissions :"
        ls -la gradlew | awk '{print "Fichier: "$9" | Permissions: "$1" | Taille: "$5" bytes"}'
        
        # VÃ©rifier que c'est exÃ©cutable
        if [ -x "gradlew" ]; then
          echo "ğŸ¯ gradlew est exÃ©cutable"
        else
          echo "âŒ ERREUR: gradlew n'est toujours pas exÃ©cutable"
          exit 1
        fi
        
    - name: ğŸ“¦ DOWNLOAD gradle-wrapper.jar
      run: |
        echo "ğŸ“¦ TÃ©lÃ©chargement de gradle-wrapper.jar..."
        mkdir -p gradle/wrapper
        cd gradle/wrapper
        curl -L -o gradle-wrapper.jar https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar
        echo "âœ… TÃ©lÃ©chargÃ©: $(du -h gradle-wrapper.jar | cut -f1)"
        cd ../..
        
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ§ª TEST gradlew
      run: |
        echo "ğŸ§ª Test critique de gradlew..."
        # VÃ©rifier le contenu Ã  la ligne 152
        echo "ğŸ” Ligne 152 :"
        sed -n '152p' gradlew || echo "Fichier trop court"
        
        # Premier test
        echo "ğŸš€ Lancement de gradlew --version..."
        ./gradlew --version
        
        echo "âœ… Test rÃ©ussi !"
        
    - name: ğŸ—ï¸ BUILD APK
      run: |
        echo "ğŸš€ Construction de l'APK..."
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ğŸ“¦ UPLOAD APK
      uses: actions/upload-artifact@v4
      with:
        name: ocr-scanner-app
        path: app/build/outputs/apk/debug/*.apk
        if-no-files-found: warn
