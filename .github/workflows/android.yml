name: OCR Scanner - Gradle 8 Fix

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Fix Gradle 8 configuration
      run: |
        echo "ðŸ”§ Configuration pour Gradle 8..."
        
        # 1. build.gradle SIMPLE (sans repositories)
        cat > build.gradle << 'EOF'
        buildscript {
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.0'
                classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0'
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # 2. settings.gradle CORRECT
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
            repositories {
                google()
                mavenCentral()
            }
        }
        
        rootProject.name = "OCRScanner"
        include ':app'
        EOF
        
        # 3. app/build.gradle de base
        if [ ! -f "app/build.gradle" ]; then
          mkdir -p app
          cat > app/build.gradle << 'APP'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          android {
              namespace 'com.yourapp.ocrscanner'
              compileSdk 34
              defaultConfig {
                  applicationId "com.yourapp.ocrscanner"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
          }
          APP
        fi
        
        echo "âœ… Configuration Gradle 8 prÃªte"
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ¤– Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ðŸ§ª Test
      run: |
        chmod +x gradlew
        ./gradlew --version
        
    - name: ðŸ—ï¸ Build
      run: |
        echo "ðŸš€ Build avec Gradle 8..."
        ./gradlew clean assembleDebug
        
    - name: ðŸ“¦ Upload
      uses: actions/upload-artifact@v4
      with:
        name: ocr-apk
        path: app/build/outputs/apk/debug/*.apk
