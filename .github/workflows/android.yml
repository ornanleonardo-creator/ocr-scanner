name: OCR Scanner - Simple Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Create minimal files
      run: |
        echo "ğŸ”§ CrÃ©ation des fichiers minimaux..."
        
        # 1. build.gradle SIMPLE
        echo 'buildscript {' > build.gradle
        echo '    dependencies {' >> build.gradle
        echo '        classpath "com.android.tools.build:gradle:8.1.0"' >> build.gradle
        echo '        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0"' >> build.gradle
        echo '    }' >> build.gradle
        echo '}' >> build.gradle
        echo '' >> build.gradle
        echo 'task clean(type: Delete) {' >> build.gradle
        echo '    delete rootProject.buildDir' >> build.gradle
        echo '}' >> build.gradle
        
        # 2. settings.gradle CORRECT
        echo 'pluginManagement {' > settings.gradle
        echo '    repositories {' >> settings.gradle
        echo '        google()' >> settings.gradle
        echo '        mavenCentral()' >> settings.gradle
        echo '        gradlePluginPortal()' >> settings.gradle
        echo '    }' >> settings.gradle
        echo '}' >> settings.gradle
        echo '' >> settings.gradle
        echo 'dependencyResolutionManagement {' >> settings.gradle
        echo '    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)' >> settings.gradle
        echo '    repositories {' >> settings.gradle
        echo '        google()' >> settings.gradle
        echo '        mavenCentral()' >> settings.gradle
        echo '    }' >> settings.gradle
        echo '}' >> settings.gradle
        echo '' >> settings.gradle
        echo 'rootProject.name = "OCRScanner"' >> settings.gradle
        echo 'include '\'':app'\' >> settings.gradle
        
        # 3. app/build.gradle si manquant
        if [ ! -f "app/build.gradle" ]; then
          mkdir -p app
          echo 'plugins {' > app/build.gradle
          echo '    id "com.android.application"' >> app/build.gradle
          echo '    id "org.jetbrains.kotlin.android"' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo '' >> app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.yourapp.ocrscanner"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.yourapp.ocrscanner"' >> app/build.gradle
          echo '        minSdk 24' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    buildTypes {' >> app/build.gradle
          echo '        release {' >> app/build.gradle
          echo '            minifyEnabled false' >> app/build.gradle
          echo '        }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo '' >> app/build.gradle
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.core:core-ktx:1.12.0"' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '}' >> app/build.gradle
        fi
        
        echo "âœ… Fichiers crÃ©Ã©s"
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ğŸ—ï¸ Build
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug
        
    - name: ğŸ“¦ Upload
      uses: actions/upload-artifact@v4
      with:
        name: ocr-apk
        path: app/build/outputs/apk/debug/*.apk
