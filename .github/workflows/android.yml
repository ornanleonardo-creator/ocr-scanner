name: Build OCR Scanner APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Ensure correct build.gradle
      run: |
        # S'assurer que build.gradle est correct
        cat > build.gradle << 'EOF'
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.0'
                classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0'
            }
        }
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸ› ï¸ Prepare Gradle
      run: |
        chmod +x gradlew
        # Tester que Gradle fonctionne
        ./gradlew --version
        
    - name: ðŸ—ï¸ Build APK with dependencies
      run: |
        echo "ðŸš€ Construction avec dÃ©pendances..."
        
        # Mettre Ã  jour app/build.gradle avec les dÃ©pendances nÃ©cessaires
        if [ -f "app/build.gradle" ]; then
          echo "ðŸ“ Mise Ã  jour des dÃ©pendances..."
          # Ajouter CameraX et ML Kit
          sed -i '/dependencies {/a\    implementation '"'"'androidx.core:core-ktx:1.12.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'androidx.appcompat:appcompat:1.6.1'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'com.google.android.material:material:1.10.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'androidx.camera:camera-core:1.3.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'androidx.camera:camera-camera2:1.3.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'androidx.camera:camera-lifecycle:1.3.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'androidx.camera:camera-view:1.3.0'"'"'' app/build.gradle
          sed -i '/dependencies {/a\    implementation '"'"'com.google.mlkit:text-recognition:16.0.0'"'"'' app/build.gradle
        fi
        
        # Build
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ðŸ“¦ Package APK for upload
      run: |
        echo "ðŸ“¦ PrÃ©paration de l'APK..."
        
        # Chercher l'APK debug
        APK_PATH=$(find . -path "*/outputs/apk/debug/*.apk" -type f | head -1)
        
        if [ -z "$APK_PATH" ]; then
          # Essayer un autre chemin
          APK_PATH=$(find . -name "*debug*.apk" -type f | head -1)
        fi
        
        if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
          echo "âœ… APK trouvÃ©: $APK_PATH"
          echo "ðŸ“Š Taille: $(du -h "$APK_PATH" | cut -f1)"
          
          # CrÃ©er un dossier pour l'artifact
          mkdir -p release
          cp "$APK_PATH" release/ocr-scanner.apk
          
          # CrÃ©er un fichier d'info
          echo "OCR Scanner v1.0" > release/version.txt
          echo "Build: $(date)" >> release/version.txt
          echo "APK: $(basename "$APK_PATH")" >> release/version.txt
        else
          echo "âŒ Aucun APK trouvÃ©!"
          echo "ðŸ“ Recherche approfondie..."
          find . -type f -name "*.apk" 2>/dev/null || echo "Vraiment aucun APK"
          exit 1
        fi
        
    - name: â¬†ï¸ Upload Release
      uses: actions/upload-artifact@v4
      with:
        name: ocr-scanner-release
        path: release/
        retention-days: 30
        
    - name: ðŸ“ Create success page
      run: |
        echo "# ðŸŽ‰ OCR Scanner APK" > README-APK.md
        echo "" >> README-APK.md
        echo "## ðŸ“± Application de scanner OCR avec camÃ©ra" >> README-APK.md
        echo "" >> README-APK.md
        echo "### âœ¨ FonctionnalitÃ©s" >> README-APK.md
        echo "- ðŸ“¸ CamÃ©ra en temps rÃ©el" >> README-APK.md
        echo "- ðŸ” Reconnaissance de texte (OCR)" >> README-APK.md
        echo "- ðŸ“ Import depuis galerie" >> README-APK.md
        echo "- ðŸ’¾ Sauvegarde des rÃ©sultats" >> README-APK.md
        echo "" >> README-APK.md
        echo "### ðŸ“¥ Installation" >> README-APK.md
        echo "1. TÃ©lÃ©chargez `ocr-scanner.apk` depuis Artifacts" >> README-APK.md
        echo "2. Sur Android : **ParamÃ¨tres â†’ SÃ©curitÃ© â†’ Sources inconnues**" >> README-APK.md
        echo "3. Installez et lancez l'application" >> README-APK.md
        echo "" >> README-APK.md
        echo "*Build automatique avec GitHub Actions*" >> README-APK.md
