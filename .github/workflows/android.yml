name: OCR Scanner Full Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Fix all permissions and files
      run: |
        echo "ğŸ”§ RÃ©paration complÃ¨te..."
        
        # 1. S'assurer que gradlew est exÃ©cutable
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo "âœ… gradlew rendu exÃ©cutable"
        else
          echo "ğŸ“¥ TÃ©lÃ©chargement de gradlew..."
          curl -L -o gradlew https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x gradlew
        fi
        
        # 2. VÃ©rifier build.gradle
        if [ ! -f "build.gradle" ]; then
          echo "ğŸ“ CrÃ©ation de build.gradle..."
          echo 'buildscript{repositories{google();mavenCentral()}dependencies{classpath"com.android.tools.build:gradle:8.1.0";classpath"org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0"}}' > build.gradle
          echo 'allprojects{repositories{google();mavenCentral()}}' >> build.gradle
          echo 'task clean(type:Delete){delete rootProject.buildDir}' >> build.gradle
        fi
        
        # 3. VÃ©rifier app/build.gradle
        if [ ! -f "app/build.gradle" ]; then
          echo "ğŸ“± CrÃ©ation de app/build.gradle..."
          mkdir -p app
          echo 'plugins{id"com.android.application";id"org.jetbrains.kotlin.android"}' > app/build.gradle
          echo 'android{namespace"com.yourapp.ocrscanner";compileSdk 34' >> app/build.gradle
          echo 'defaultConfig{applicationId"com.yourapp.ocrscanner";minSdk 24;targetSdk 34;versionCode 1;versionName"1.0"}' >> app/build.gradle
          echo 'buildTypes{release{minifyEnabled false}}' >> app/build.gradle
          echo 'compileOptions{sourceCompatibility JavaVersion.VERSION_17;targetCompatibility JavaVersion.VERSION_17}' >> app/build.gradle
          echo 'kotlinOptions{jvmTarget="17"}}' >> app/build.gradle
          echo 'dependencies{implementation"androidx.core:core-ktx:1.12.0";implementation"androidx.appcompat:appcompat:1.6.1";implementation"com.google.android.material:material:1.10.0"}' >> app/build.gradle
        fi
        
        # 4. VÃ©rifier wrapper jar
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "ğŸ“¦ TÃ©lÃ©chargement de gradle-wrapper.jar..."
          mkdir -p gradle/wrapper
          cd gradle/wrapper
          curl -L -o gradle-wrapper.jar https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar
          cd ../..
        fi
        
        echo "âœ… Tous les fichiers sont prÃªts"
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android
      uses: android-actions/setup-android@v3
      
    - name: ğŸ§ª Final test
      run: |
        echo "ğŸ§ª Test final..."
        ./gradlew --version
        echo "âœ… Test rÃ©ussi"
        
    - name: ğŸ—ï¸ Build
      run: |
        echo "ğŸš€ Build en cours..."
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ğŸ“¦ Upload
      uses: actions/upload-artifact@v4
      with:
        name: ocr-app
        path: app/build/outputs/apk/debug/*.apk
        if-no-files-found: error
