name: Build OCR Scanner - FIXED

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—‘ï¸ DELETE problematic build.gradle
      run: |
        echo "ğŸ—‘ï¸ Suppression du fichier build.gradle problÃ©matique..."
        rm -f build.gradle
        echo "âœ… Fichier supprimÃ©"
        
    - name: ğŸ†• CREATE new clean build.gradle
      run: |
        echo "ğŸ†• CrÃ©ation d'un nouveau build.gradle..."
        cat > build.gradle << 'GRADLE'
        // build.gradle racine - Version simple et propre
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.0'
                classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.0'
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        GRADLE
        
        echo "âœ… Nouveau build.gradle crÃ©Ã©"
        echo "ğŸ“„ Contenu :"
        cat -n build.gradle
        
    - name: ğŸ“± CREATE app/build.gradle if missing
      run: |
        if [ ! -f "app/build.gradle" ]; then
          echo "ğŸ“ CrÃ©ation de app/build.gradle..."
          mkdir -p app
          cat > app/build.gradle << 'APP_GRADLE'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          android {
              namespace 'com.yourapp.ocrscanner'
              compileSdk 34
              defaultConfig {
                  applicationId "com.yourapp.ocrscanner"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.10.0'
          }
          APP_GRADLE
        fi
        
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ› ï¸ Test Gradle configuration
      run: |
        echo "ğŸ§ª Test de configuration..."
        chmod +x gradlew
        ./gradlew --version
        echo "âœ… Gradle fonctionne"
        
    - name: ğŸ—ï¸ Build APK
      run: |
        echo "ğŸš€ Construction de l'APK..."
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ğŸ“¦ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ocr-scanner-apk
        path: app/build/outputs/apk/debug/*.apk
